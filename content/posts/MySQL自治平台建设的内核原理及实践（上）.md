---
title: "MySQLè‡ªæ²»å¹³å°å»ºè®¾çš„å†…æ ¸åŸç†åŠå®è·µï¼ˆä¸Šï¼‰"
date: 2023-12-18T02:43:36+0000
tags: [ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ, åŸºç¡€ç ”å‘å¹³å°, è¿ç»´, MySQL, æ•°æ®åº“, é«˜å¯ç”¨, å®¹ç¾]
---

| **Bç«™è§†é¢‘**ï¼š[ç¾å›¢æ•°æ®åº“è‡ªæ²»æœåŠ¡å¹³å°å»ºè®¾](https://www.bilibili.com/video/BV1Uo4y1r7kp/?spm_id_from=333.999.0.0)


## 1 èƒŒæ™¯&ç›®æ ‡


MySQLçš„æ•…éšœä¸SQLçš„æ€§èƒ½ï¼Œæ˜¯DBAè·Ÿç ”å‘åŒå­¦æ¯å¤©éƒ½éœ€è¦å…³æ³¨çš„ä¸¤ä¸ªé‡è¦é—®é¢˜ï¼Œå®ƒä»¬ç›´æ¥å½±å“ç€æ•°æ®åº“è·Ÿä¸šåŠ¡åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§ã€‚è€Œå½“æ•…éšœæˆ–è€…SQLæ€§èƒ½é—®é¢˜å‘ç”Ÿæ—¶ï¼Œå¦‚ä½•å¿«é€Ÿå‘ç°ã€åˆ†æä»¥åŠå¤„ç†è¿™äº›é—®é¢˜ï¼Œä½¿å¾—æ•°æ®åº“æˆ–è€…ä¸šåŠ¡ç³»ç»Ÿå¿«é€Ÿæ¢å¤ï¼Œæ˜¯ä¸€é¡¹æ¯”è¾ƒå¤§çš„æŒ‘æˆ˜ã€‚



é’ˆå¯¹æ­¤é—®é¢˜ï¼Œç¾å›¢æ•°æ®åº“è‡ªæ²»å¹³å°ç»è¿‡å¤šè½®çš„è¿­ä»£å»ºè®¾ï¼Œåœ¨å¤šä¸ªåœºæ™¯ä¸‹å·²ç»å®ç°äº†å¼‚å¸¸çš„å‘ç°ã€åˆ†æä»¥åŠå¤„ç†çš„ç«¯åˆ°ç«¯èƒ½åŠ›ã€‚æœ¬æ–‡å°†è·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹æˆ‘ä»¬å¹³å°å»ºè®¾çš„å¿ƒè·¯å†ç¨‹ï¼ŒåŒæ—¶æä¾›ä¸€äº›ç»éªŒã€æ•™è®­ä¾›åŒè¡Œå‚è€ƒï¼Œå¸Œæœ›èƒ½å¤Ÿèµ·åˆ°â€œæŠ›ç –å¼•ç‰â€çš„ä½œç”¨ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»ä»¥ä¸‹ä¸»é¢˜ï¼š



* **å¼‚å¸¸å‘ç°**ï¼šåŸºäºæ•°ç†ç»Ÿè®¡æ–¹å¼çš„åŠ¨æ€é˜€å€¼ç­–ç•¥ï¼Œæ¥å‘ç°æ•°æ®åº“ç³»ç»Ÿçš„æŒ‡æ ‡å¼‚å¸¸ã€‚
* **æ•…éšœåˆ†æ**ï¼šä¸°å¯Œå®Œå–„æ•°æ®åº“å…³é”®ä¿¡æ¯ï¼Œæ¥åšç²¾ç¡®çš„æ•°æ®åº“å¼‚å¸¸æ ¹å› åˆ†æï¼›æ·±å…¥æŒ–æ˜å†…æ ¸ä»·å€¼ï¼Œæ¥è§£å†³æ ¹å› è¯Šæ–­æ–¹é¢çš„ç–‘éš¾æ‚ç—‡ã€‚
* **æ•…éšœå¤„ç†**ï¼šä¾æ®å¼‚å¸¸æ ¹å› åˆ†æçš„ä¸åŒç»“æœï¼Œé€šè¿‡è‡ªåŠ©åŒ–æˆ–è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥è¿›è¡Œæ•…éšœçš„æ¢å¤å¤„ç†ã€‚
* **å†…æ ¸å¯è§‚æµ‹æ€§å»ºè®¾**ï¼šå¦‚ä½•è·Ÿæ•°æ®åº“å†…æ ¸å›¢é˜Ÿåˆä½œï¼Œä»å†…æ ¸çš„è§’åº¦æ¥åˆ†æSQLæ€§èƒ½é—®é¢˜ï¼Œé€šè¿‡å†…æ ¸å›¢é˜Ÿå¤§é‡çš„å†…æ ¸ä»£ç æ”¹é€ ï¼ŒåŠ›æ±‚å°†æ•°æ®åº“çš„å¯è§‚æµ‹æ€§è·Ÿè¯Šæ–­åšåˆ°æè‡´ã€‚
* **å•SQLä¼˜åŒ–å»ºè®®**ï¼šé€šè¿‡æ”¹é€ MySQLå­˜å‚¨å¼•æ“ï¼ŒåŒæ—¶ç»“åˆæŸ¥è¯¢ä¼˜åŒ–æ¥æ‰“é€ åŸºäºCostæ¨¡å¼çš„ç´¢å¼•ä¼˜åŒ–å»ºè®®ã€‚
* **åŸºäºworkloadç´¢å¼•ä¼˜åŒ–å»ºè®®**ï¼šåŸºäºæ•´ä¸ªDBæˆ–è€…å®ä¾‹çš„Workloadç­–ç•¥çš„ç´¢å¼•ä¼˜åŒ–å»ºè®®ï¼Œä¸ºå®ç°æ•°æ®åº“çš„ç´¢å¼•è‡ªç»´æŠ¤æä¾›å‰ç½®æ¡ä»¶ã€‚
* **åŸºäºSQLç”Ÿå‘½å‘¨æœŸçš„æ²»ç†**ï¼šå®ç°ä»SQLä¸Šçº¿å‰ã€æ‰§è¡Œè¿‡ç¨‹ä¸­ã€æ‰§è¡Œå®Œæ¯•åå‡ ä¸ªç¯èŠ‚ï¼Œä»¥æœŸå®ç°ç«¯åˆ°ç«¯çš„æ…¢SQLæ²»ç†ã€‚


## 2 å¹³å°æ¼”è¿›ç­–ç•¥


ç¾å›¢æ•°æ®åº“è‡ªæ²»å¹³å°ä»ä¸‹åˆ°ä¸Šæ€»ä½“åˆ†ä¸ºå››å±‚ï¼Œåˆ†åˆ«ä¸ºæ¥å£ä¸å±•ç¤ºã€å¹³å°åŠŸèƒ½å±‚ï¼Œè®¡ç®—ä¸å­˜å‚¨ã€æ•°æ®é‡‡é›†å±‚ï¼Œå¹³å°çš„æ€»ä½“æ¶æ„ä»¥åŠæ¯ä¸€å±‚çš„ä½œç”¨å¦‚ä¸‹ï¼š



![](https://p0.meituan.net/travelcube/9a9840e7d0a6abfe4c9f96ab2ccba332644108.png)



* **æ•°æ®åº“é‡‡é›†å±‚**ï¼šè¦è¿›è¡Œæ•°æ®åº“çš„è¯Šæ–­ä¸åˆ†æï¼Œéœ€è¦ä¾é å…³é”®çš„æŒ‡æ ‡ä»¥åŠSQLæ–‡æœ¬æ•°æ®ï¼Œå½“å‰åœ¨æ¯ä¸ªæ•°æ®åº“å®ä¾‹ä¸Šéƒ¨ç½²ä¸€ä¸ªæ•°æ®é‡‡é›†ç¨‹åºï¼ˆrds\-agentï¼‰ç»Ÿä¸€è´Ÿè´£é‡‡é›†ã€ä¸ŠæŠ¥å…³é”®æ•°å€¼æŒ‡æ ‡ä»¥åŠSQLæ–‡æœ¬æ•°æ®ã€‚
* **æ•°æ®è®¡ç®—ä¸å­˜å‚¨å±‚**ï¼šæ•°æ®é‡‡é›†å±‚ä¸ŠæŠ¥ä¸Šæ¥çš„æ•°æ®ï¼Œä¾æ‰˜Kafkaã€Flink&Sparkä½œä¸ºæ•°æ®ç¼“å†²ï¼Œå¯¹å…³é”®ç»„ä»¶è¿›è¡Œç›¸å…³çš„æ•°æ®å¤„ç†ï¼Œå¦‚SQLè§£æã€SQLæ¨¡ç‰ˆåŒ–ã€æ•°æ®èšåˆç­‰æ“ä½œï¼Œå†æŠŠå¤„ç†çš„ç»“æœå­˜å…¥ESã€Bladeï¼ˆç¾å›¢è‡ªç ”çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼‰ã€Hiveç­‰åˆ†å¸ƒå¼æ•°æ®åº“æˆ–è€…å¤§æ•°æ®å¹³å°ï¼Œæä¾›ç»™ä¸Šå±‚çš„å¹³å°åŠŸèƒ½å±‚ä½¿ç”¨ã€‚
* **å¹³å°åŠŸèƒ½å±‚**ï¼šæ­¤å±‚æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€ä¸ºé‡è¦çš„éƒ¨åˆ†ï¼Œç”±äºå¹³å°åŒæ—¶æœåŠ¡äºDBAè¿ç»´å›¢é˜ŸåŠç ”å‘å›¢é˜Ÿï¼Œæ‰€ä»¥å¹³å°çš„å»ºè®¾åˆ†æˆäº†ä¸¤æ¡è·¯ï¼š1ï¼‰ä¸»è¦é¢å‘DBAç”¨æˆ·ï¼ŒæŒ‰ç…§å¯è§‚æµ‹æ€§å»ºè®¾ã€å¼‚å¸¸å‘ç°ã€æ•…éšœæ ¹å› åˆ†æã€æ•…éšœå¤„ç†å‡ ä¸ªé˜¶æ®µæ¥è¿›è¡Œå»ºè®¾ï¼›2ï¼‰ä¸»è¦é¢å‘ç ”å‘åŒå­¦ï¼ŒæŒ‰ç…§SQLä¼˜åŒ–å»ºè®®ã€é£é™©SQLçš„å‘ç°ã€åˆ†æä¸SQLæ²»ç†ç­‰è·ŸSQLç›¸å…³çš„å‡ ä¸ªé˜¶æ®µæ¥å»ºè®¾ã€‚å½“ç„¶ï¼Œä¸¤è€…å¹¶æ²¡æœ‰ä¸¥æ ¼ç•Œé™ï¼Œè¿™äº›åŠŸèƒ½æ‰€æœ‰çš„ç”¨æˆ·éƒ½å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚
* **æ¥å£ä¸å±•ç¤º**ï¼šå¹³å°åŠŸèƒ½å±‚æä¾›çš„æ ¸å¿ƒåŠŸèƒ½ä¼šé€šè¿‡Portalæ¥å±•ç¤ºï¼ŒåŒæ—¶ä¸ºäº†è®©å¹³å°æä¾›çš„åŠŸèƒ½æ›´å¥½åœ°é›†æˆåœ¨ç”¨æˆ·è‡ªå·±çš„ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¹Ÿé€šè¿‡OpenAPIçš„æ–¹å¼å¯¹å¤–æä¾›æœåŠ¡ã€‚


## 3 å¼‚å¸¸å‘ç°


æ•°æ®åº“äº§ç”Ÿå¼‚å¸¸æ—¶éœ€è¦å°½æ—©åœ°å‘ç°ï¼Œæ‰èƒ½é˜²æ­¢å¼‚å¸¸ä¸€è¿›æ­¥æ”¾å¤§ï¼Œé¿å…é€ æˆçœŸæ­£çš„æ•…éšœã€‚å¼‚å¸¸å‘ç°çš„ä¸»è¦æ–¹å¼æ˜¯å¯¹æ•°æ®åº“æˆ–è€…OSçš„å…³é”®æ•°å€¼æŒ‡æ ‡è¿›è¡Œç›‘æ§ï¼Œç›¸å…³æŒ‡æ ‡åŒ…æ‹¬seconds\_behind\_masterã€slow\_queriesã€thread\_runningã€system loadã€Threads\_connectedç­‰ç­‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸šåŠ¡ç«¯ç ”å‘å…³æ³¨çš„å…³é”®æŒ‡æ ‡ï¼Œå¦‚â€œåº”ç”¨ç¨‹åºè®¿é—®æ•°æ®åº“çš„æŠ¥é”™æ•°é‡â€ã€â€œSQLæ‰§è¡Œå¹³å‡è€—æ—¶â€ç­‰æŒ‡æ ‡æ¥è¿›è¡Œç›‘æ§ã€‚å¦‚æœè¿™äº›æŒ‡æ ‡çŸ­æ—¶é—´å†…å‘ç”Ÿæ¯”è¾ƒå¤§çš„æ³¢åŠ¨ï¼Œé‚£ä¹ˆæ•°æ®åº“å¾ˆå¯èƒ½å‡ºç°äº†ä¸€äº›å¼‚å¸¸ï¼Œè¿™å°±éœ€è¦åŠæ—¶è¿›è¡Œå¤„ç†ã€‚



è¿™äº›å¼‚å¸¸å¦‚ä½•æ‰èƒ½è¢«å‘ç°å‘¢ï¼Ÿä¸šç•Œä¸€èˆ¬æœ‰åŸºäºé™æ€é˜€å€¼ä»¥åŠåŠ¨æ€é˜€å€¼çš„ä¸¤ç§å¼‚å¸¸å‘ç°ç­–ç•¥ã€‚å‰è€…å¾ˆç®€å•ï¼Œå¦‚æ ¹æ®ä¸“å®¶ç»éªŒï¼Œäººå·¥è®¾å®šseconds\_behind\_masteræˆ–è€…Threads\_connectedçš„å‘Šè­¦é˜€å€¼ï¼Œè¶…è¿‡é˜€å€¼å°±è®¤ä¸ºå‘ç”Ÿäº†å¼‚å¸¸ã€‚æ­¤æ–¹å¼è™½ç„¶ç®€å•æ˜“ç”¨ï¼Œä½†OLTPã€OLAPç­‰ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯¹äºç›¸åŒæŒ‡æ ‡çš„æ•æ„Ÿåº¦æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœæ‰€æœ‰åœºæ™¯éƒ½ä½¿ç”¨ç»Ÿä¸€çš„é™æ€é˜€å€¼æ¥åšå¼‚å¸¸å‘ç°ï¼Œéš¾å…ä¼šæœ‰å¾ˆå¤šè¯¯å‘Šã€‚è€Œå¦‚æœæ¯ä¸ªåœºæ™¯éƒ½å»æ‰‹å·¥å»è°ƒæ•´ï¼Œæ—¢ä¸çµæ´»ï¼Œæˆæœ¬åˆå¤ªé«˜ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åŸºäºä¸åŒåœºæ™¯çš„å†å²æ—¶åºæ•°æ®ï¼Œä½¿ç”¨æ•°ç†ç»Ÿè®¡çš„æ–¹å¼æ¥åˆ†åˆ«å»ºæ¨¡ï¼Œé€šè¿‡æ‹Ÿåˆå‡ºå„è‡ªåœºæ™¯çš„æ¨¡å‹æ¥ä½œä¸ºå¼‚å¸¸å‘ç°çš„ç­–ç•¥ã€‚



### 3.1 æ•°æ®åˆ†å¸ƒè§„å¾‹ä¸ç®—æ³•é€‰æ‹©


åŸºäºæ•°ç†ç»Ÿè®¡æ–¹æ³•çš„å¼‚å¸¸å‘ç°ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„åœºæ™¯ä½¿ç”¨ç‰¹å®šçš„æ¨¡å‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ¨¡å‹çš„é€‰æ‹©è·Ÿæ—¶åºæ•°æ®çš„åˆ†å¸ƒå½¢æ€æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œæ—¶åºæ•°æ®çš„åˆ†å¸ƒå¹¶ä¸æ€»æ˜¯éƒ½åƒæ­£æ€åˆ†å¸ƒä¸€æ ·éƒ½æ˜¯å¯¹ç§°çš„ï¼Œè€Œæ˜¯æœ‰äº›æ˜¯å·¦åçš„ï¼Œæœ‰äº›æ˜¯å³åçš„ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯¹ç§°åˆ†å¸ƒçš„ã€‚ä¸‹å›¾å°±å±•ç¤ºå…¸å‹çš„ä¸‰ç§ä¸åŒçš„æ—¶åºæ•°æ®åˆ†å¸ƒå½¢æ€ã€‚



![](https://p1.meituan.net/travelcube/30e354355300507f88a558668146db1f147643.png)



é’ˆå¯¹ä¸Šé¢çš„ä¸‰ç§ä¸åŒæ—¶åºæ•°æ®çš„åˆ†å¸ƒå½¢æ€ï¼Œä»¥åŠæ¯ç§å¼‚å¸¸æ£€æµ‹ç®—æ³•è‡ªèº«çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬åˆ†åˆ«é‡‡ç”¨ä¸åŒçš„å¼‚å¸¸æ£€æµ‹ç®—æ³•ã€‚



å¯¹äºä½åæ€é«˜å¯¹ç§°åˆ†å¸ƒé€‰æ‹©â€œç»å¯¹ä¸­ä½å·®ï¼ˆMADï¼‰â€ï¼Œä¸­ç­‰åæ€åˆ†å¸ƒé€‰æ‹©â€œç®±å½¢å›¾ï¼ˆBoxplotï¼‰â€ï¼Œé«˜åæ€åˆ†å¸ƒé€‰æ‹©â€œæå€¼ç†è®ºï¼ˆEVTï¼‰â€ã€‚æ²¡æœ‰é€‰æ‹©3Sigmaçš„ä¸»è¦åŸå› æ˜¯ï¼šå®ƒå¯¹å¼‚å¸¸å®¹å¿åº¦è¾ƒä½ï¼ˆå»ºæ¨¡çš„æ—¶å€™ï¼Œå¦‚æœæœ‰å™ªéŸ³ç­‰å¼‚å¸¸ç‚¹ä¹Ÿä¸ä¼šå¯¹æ¨¡å‹çš„å½¢æ€äº§ç”Ÿå¾ˆå¤§çš„å½±å“ï¼Œåˆ™è¯´æ˜å¼‚å¸¸å®¹å¿åº¦å¾ˆé«˜ï¼‰ï¼Œè€Œç»å¯¹ä¸­ä½å·®ï¼ˆMADï¼‰ä»ç†è®ºä¸Šè€Œè¨€å…·æœ‰æ›´å¥½çš„å¼‚å¸¸å®¹å¿åº¦ï¼Œæ‰€ä»¥åœ¨æ•°æ®å‘ˆç°é«˜å¯¹ç§°åˆ†å¸ƒæ—¶ï¼Œé€šè¿‡ç»å¯¹ä¸­ä½å·®æ›¿ä»£3Sigmaæ¥è¿›è¡Œæ£€æµ‹ã€‚



![](https://p1.meituan.net/travelcube/c84ea5f3a163c092db38927c19f5457d490656.png)



### 3.2 æ¨¡å‹é€‰æ‹©


æ•°æ®åˆ†å¸ƒè·Ÿç®—æ³•é€‚ç”¨åœºæ™¯çš„åˆ†æä¹‹åï¼Œå¯¹å†…éƒ¨çš„æ—¶åºæ•°æ®è¿›è¡Œæ£€æŸ¥ï¼Œå‘ç°æ•°æ®çš„è§„å¾‹ä¸»è¦å‘ˆç°æ¼‚ç§»ã€å‘¨æœŸå’Œå¹³ç¨³ä¸‰ç§çŠ¶æ€ï¼Œå¯¹æ ·æœ¬å…ˆè¿›è¡Œæ—¶åºçš„æ¼‚ç§»ï¼ˆå¦‚æœæ£€æµ‹å­˜åœ¨æ¼‚ç§»çš„åœºæ™¯ï¼Œåˆ™éœ€è¦æ ¹æ®æ£€æµ‹è·å¾—çš„æ¼‚ç§»ç‚¹tæ¥åˆ‡å‰²è¾“å…¥æ—¶åºï¼Œä½¿ç”¨æ¼‚ç§»ç‚¹åçš„æ—¶åºæ ·æœ¬ä½œä¸ºåç»­å»ºæ¨¡æµç¨‹çš„è¾“å…¥ï¼‰ã€‚



ä¹‹ååŒæ—¶è¿›è¡Œå¹³ç¨³æ€§åˆ†æï¼ˆå¦‚æœè¾“å…¥æ—¶åºSæ»¡è¶³å¹³ç¨³æ€§æ£€éªŒï¼Œåˆ™ç›´æ¥é€šè¿‡ç®±å½¢å›¾æˆ–ç»å¯¹ä¸­ä½å·®çš„æ–¹å¼æ¥è¿›è¡Œå»ºæ¨¡ï¼‰ä»¥åŠå‘¨æœŸåˆ†æï¼ˆå­˜åœ¨å‘¨æœŸæ€§çš„æƒ…å†µä¸‹ï¼Œå°†å‘¨æœŸè·¨åº¦è®°ä¸ºTï¼Œå°†è¾“å…¥æ—¶åºSæ ¹æ®è·¨åº¦Tè¿›è¡Œåˆ‡å‰²ï¼Œé’ˆå¯¹å„ä¸ªæ—¶é—´ç´¢å¼•jâˆˆ{0,1,â‹¯,Tâˆ’1} æ‰€ç»„æˆçš„æ•°æ®æ¡¶è¿›è¡Œå»ºæ¨¡æµç¨‹ã€‚ä¸å­˜åœ¨å‘¨æœŸæ€§çš„æƒ…å†µä¸‹ï¼Œé’ˆå¯¹å…¨éƒ¨è¾“å…¥æ—¶åºSä½œä¸ºæ•°æ®æ¡¶è¿›è¡Œå»ºæ¨¡æµç¨‹ï¼‰ï¼Œå†å¯¹æ—¶åºæ•°æ®åˆ†å¸ƒç‰¹æ€§è¿›è¡Œååº¦çš„è®¡ç®—ï¼Œæœ€åå†æ ¹æ®ä¸åŒçš„ååº¦ç‰¹æ€§é€‰æ‹©ä¸åŒçš„ç®—æ³•æ¨¡å‹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š



![](https://p0.meituan.net/travelcube/9b06a19c6e15c96662b64f12ff1c5e98160744.png)



åœ¨ç®—æ³•ç¡®å®šä¹‹åï¼Œå…ˆåœ¨ç¦»çº¿ç¯å¢ƒé’ˆå¯¹ä¸åŒçš„åœºæ™¯ä½¿ç”¨å†å²æŒ‡æ ‡æ¥è®­ç»ƒæ¨¡å‹ï¼Œæ¨¡å‹è®­ç»ƒå®Œæ¯•ä¹‹åä¼šå­˜å…¥æ•°æ®åº“ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹äºä¸åŒåœºæ™¯ä¸‹çš„æ•°å€¼æŒ‡æ ‡æ ¹æ®å…¶ç‰¹æ€§æ¥åŠ è½½ä¸åŒçš„æ¨¡å‹ï¼Œå¹¶ä¸”ç»“åˆFlinkå®æ—¶è®¡ç®—æ¡†æ¶æ¥å®æ—¶çš„å‘ç°æŒ‡æ ‡çš„å¼‚å¸¸å¹¶è¿›è¡Œå‘Šè­¦ã€‚



![](https://p0.meituan.net/travelcube/789f0f43ab42edcf5a254b749a1e072e194624.png)



## 4 å¼‚å¸¸è¯Šæ–­


å‘ç°æŒ‡æ ‡å¼‚å¸¸åï¼Œéœ€è¦å¿«é€Ÿçš„ç»™å‡ºå¼‚å¸¸çš„æ ¹å› ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…·ä½“çš„æ ¹å› æ¥é€‰æ‹©ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼Œç„¶åè¿›è¡Œè‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨çš„æ¢å¤å·¥ä½œã€‚æ ¹å› åˆ†æå¯ä»¥åŸºäºä¸“å®¶ç»éªŒï¼Œä¹Ÿå¯ä»¥ä¸¥æ ¼åœ°æŒ‰ç…§å†…æ ¸ä»£ç çš„é€»è¾‘æ¥è¿›è¡Œåˆ†æã€‚



![](https://p0.meituan.net/travelcube/378f1890eff4fdc6bda63c08bb47e1cc98398.png)



æœ¬æ–‡é‡ç‚¹è®²è¿°åè€…ï¼Œå¼ºè°ƒå¦‚ä½•ä½¿ç”¨â€œå†…æ ¸æ€ç»´â€æ¥è§£å†³ä¸“å®¶ç»éªŒå¾ˆéš¾æˆ–è€…æ— æ³•è§£å†³çš„è¯Šæ–­é—®é¢˜ã€‚æœ¬æ–‡å°†åˆ—ä¸¾â€œå†…æ ¸ä»£ç è·¯å¾„åˆ†æâ€ã€â€å†…æ ¸æ—¥å¿—åˆ†æâ€ã€â€œå†…æ ¸åŠŸèƒ½å¢å¼ºâ€œã€â€œå†…æ ¸Core Dumpåˆ†æâ€ä»¥åŠâ€œå†…æ ¸åŸ‹ç‚¹â€ç­‰å‡ ç§ä¸åŒçš„èŒƒå¼ï¼Œæ¥è¯´æ˜æ•°æ®åº“æ ¹å› è¯Šæ–­çš„æ€è·¯ã€‚



### 4.1 ä¸»ä»å»¶è¿Ÿï¼ˆå†…æ ¸ä»£ç è·¯å¾„åˆ†æï¼‰


è¿™é‡Œå…ˆä»‹ç»â€œå†…æ ¸ä»£ç è·¯å¾„åˆ†æâ€è¿™ä¸ªæ–¹å¼æ¥è¯Šæ–­æ ¹å› ã€‚å¯¹äºæ•°æ®ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åº”ç”¨ç¨‹åºï¼Œseconds\_behind\_masteræ˜¯ä¸€ä¸ªååˆ†é‡è¦çš„æŒ‡æ ‡ï¼Œå¦‚æœå…¶å€¼è¿‡å¤§å°±éœ€è¦è¯Šæ–­å…¶æ ¹å› ï¼Œé˜²æ­¢åº”ç”¨ç¨‹åºè¯»å–åˆ°ä¸ä¸€è‡´çš„æ•°æ®ã€‚æ ¹æ®ä¸“å®¶ç»éªŒï¼Œå…¶å€¼è¿‡å¤§å¯èƒ½ç”±â€œQPSçªå¢â€ã€â€œå¤§äº‹åŠ¡â€ã€â€œå¤§è¡¨DDLâ€ã€â€œé”é˜»å¡â€ã€â€œè¡¨ç¼ºå°‘ä¸»é”®æˆ–è€…å”¯ä¸€å¥â€ã€â€œä½æ•ˆæ‰§è¡Œè®¡åˆ’â€ã€â€œç¡¬ä»¶èµ„æºä¸è¶³â€ç­‰å› æ•°é€ æˆï¼ŒæŠŠè¿™äº›ä¸“å®¶ç»éªŒæ€»ç»“æˆè§„åˆ™åˆ—è¡¨ï¼Œå½“å¼‚å¸¸äº§ç”Ÿæ—¶é€ä¸ªè¿­ä»£å»éªŒè¯æ˜¯ä¸æ˜¯ç¬¦åˆæŸä¸ªè§„åˆ™ï¼Œæ®æ­¤æ¥è¯Šæ–­æ ¹å› ï¼Œç„¶è€Œæ­¤æ–¹å¼å­˜åœ¨å¦‚ä¸‹ä¸¤å¤§é—®é¢˜ï¼š



1. **æ— æ³•æšä¸¾æ‰€æœ‰æ ¹å›** ï¼šç»éªŒç”±äºå…¶å›ºæœ‰çš„å±€é™æ€§ä¸å¯èƒ½è€ƒè™‘åˆ°æ‰€æœ‰çš„æ•…éšœåœºæ™¯ï¼Œå¦‚ä½•å®Œæ•´çš„ç»™å‡ºé€ æˆseconds\_behind\_masterå€¼å¼‚å¸¸çš„æ‰€æœ‰è§„åˆ™æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼›å¦å¤–ï¼Œå¦‚æœéœ€è¦å¯¹ä¸€ä¸ªå…¨æ–°çš„æŒ‡æ ‡è¿›è¡Œè¯Šæ–­ï¼Œè€Œåœ¨æ²¡æœ‰ä»»ä½•çš„ä¸“å®¶ç»éªŒæƒ…å†µä¸‹ï¼Œå¦‚ä½•èƒ½å¿«é€Ÿåœ°æ•´ç†å‡ºå®Œæ•´çš„è§„åˆ™åˆ—è¡¨ï¼Ÿ
2. **ç¼ºä¹å¯¹æ ¹å› çš„æ·±å±‚æ¬¡ç†è§£**ï¼šâ€œQPSçªå¢â€ã€â€œå¤§äº‹åŠ¡â€ã€â€œå¤§è¡¨DDLâ€ã€â€œé”é˜»å¡â€ã€â€œä½æ•ˆæ‰§è¡Œè®¡åˆ’â€ã€â€œç¡¬ä»¶èµ„æºä¸è¶³â€ç­‰å› ç´ ä¼šé€ æˆseconds\_behind\_masteræŒ‡æ ‡å€¼çš„å¼‚å¸¸ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿™äº›å› æ•°ä¼šé€ æˆæŒ‡æ ‡å€¼çš„å¼‚å¸¸å‘¢ï¼Ÿå¦‚æœä¸ä»å†…æ ¸æºç è§’åº¦æ¥äº†è§£è¿™äº›å› ç´ è·Ÿseconds\_behind\_masterä¹‹é—´çš„é€»è¾‘è®¡ç®—å…³ç³»ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•äº†è§£çœŸæ­£åŸå› çš„ã€‚


#### 4.1.1 å†…æ ¸ä»£ç è·¯å¾„åˆ†æ


é’ˆå¯¹ä¸Šé¢ä¸¤ä¸ªé—®é¢˜ï¼Œå…·ä½“ç­–ç•¥æ˜¯ç›´æ¥çœ‹seconds\_behind\_masterè¿™ä¸ªå˜é‡åœ¨å†…æ ¸å±‚é¢æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½å®Œæ•´çš„æšä¸¾å‡ºæ‰€æœ‰å½±å“seconds\_behind\_masterå€¼è®¡ç®—çš„å› æ•°ã€‚



ä»[æºç è§’åº¦](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/rpl_slave.cc#L3907)çœ‹ï¼Œseconds\_behind\_masterçš„å€¼ç”±â‘ time\(0\)ã€â‘¡mi\-\>rli\-\>last\_master\_timestampå’Œâ‘¢mi\-\>clock\_diff\_with\_masterè¿™ä¸‰ä¸ªå˜é‡æ¥å†³å®šï¼ˆä»£ç å±‚é¢seconds\_behind\_masterçš„è®¡ç®—é€»è¾‘æ˜¯ï¼šseconds\_behind\_master=\(\(long\)\(time\(0\) \- mi\-\>rli\-\>last\_master\_timestamp\)\- mi\-\>clock\_diff\_with\_masterï¼‰ï¼Œå…¶ä¸­time\(0\)æ˜¯ç³»ç»Ÿå½“å‰æ—¶é—´ï¼ˆç”¨ç§’è¡¨ç¤ºï¼‰ï¼Œclock\_diff\_with\_masterè¿™ä¸ªå€¼çš„è®¡ç®—å¾ˆå¤æ‚ã€åˆå¾ˆå…³é”®ï¼Œä¼šæ”¾åˆ°ä¸‹ä¸€èŠ‚è¯¦ç»†è¿›è¡Œè¯´æ˜ã€‚



è€Œé’ˆå¯¹[mi\-\>clock\_diff\_with\_master](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/rpl_slave.cc#L2894)çš„è®¡ç®—ï¼Œè¿™ä¸ªå˜é‡ä»æºç å±‚é¢çœ‹å°±æ˜¯ä¸»ã€ä»å®ä¾‹ä¹‹é—´çš„æ—¶é—´å·®ï¼›æ ¹æ®å½“å‰çš„ä¿¡æ¯å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œä»åº“çš„å½“å‰æ—¶é—´ä»¥åŠä¸»ä»åº“ä¹‹é—´çš„æ—¶é—´å·®éƒ½ä¼šå½±å“seconds\_behind\_masterå€¼çš„è®¡ç®—ã€‚seconds\_behind\_masterçš„è®¡ç®—å’Œäº‹åŠ¡åœ¨ä¸»ä»åº“æ‰§è¡Œçš„æƒ…å†µå¦‚ä¸‹ï¼š



![](https://p0.meituan.net/travelcube/04c7aab4c52f6180c9fb7a08ddaa4213112866.png)



**last\_master\_timestampè®¡ç®—é€»è¾‘**



ä»ä¸Šé¢åˆ†æå¯ä»¥çŸ¥é“ï¼Œlast\_master\_timestampå€¼æ˜¯å½±å“seconds\_behind\_masterå€¼è®¡ç®—çš„å…³é”®å˜é‡ï¼Œæ‰€ä»¥å¾ˆæœ‰å¿…è¦ä»æºç è§’åº¦åˆ†æå½±å“last\_master\_timestampå€¼çš„å› æ•°æœ‰å“ªäº›ï¼ˆä»è€Œé—´æ¥è·å–äº†å½±å“seconds\_behind\_masterå€¼çš„å› ç´ ï¼‰ã€‚



last\_master\_timestampçš„å€¼æ¥è‡ªäºä¸€ä¸ªå«rli\-\>gaq\-\>head\_queue\(\)çš„æˆå‘˜å˜é‡[new\_ts](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/rpl_rli.cc#L347)ï¼ˆæ­¤å¤„çš„rli\-\>gaq\-\>head\_queue\(\)æ˜¯æŒ‡ä»£æŸä¸ªæœ€æ–°çš„å·²ç»å®Œæˆreplayçš„äº‹åŠ¡å¯¹åº”çš„event groupï¼Œevent groupæ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡åœ¨binlogæ–‡ä»¶é‡Œç”Ÿæˆä¸€ç»„eventæ¥è¡¨ç¤ºæŸä¸ªäº‹åŠ¡ï¼Œè¿™ä¸ªevent groupé‡Œçš„eventä»ä¸»åº“ä¼ è¾“åˆ°ä»åº“åè¿›è¡Œreplayæ“ä½œæ¥è¿˜åŸä¸»åº“çš„äº‹åŠ¡ï¼‰ã€‚new\_tså€¼æ¥æºäºrli\-\>gaq\-\>head\_queue\(\)\)\-\>tsï¼Œè€Œrli\-\>gaq\-\>head\_queue\(\)\)\-\>tsçš„å€¼æ˜¯é€šè¿‡ptr\_group\-\>ts= common\_header\-\>when.tv\_sec \+ \(time\_t\) exec\_timeè®¡ç®—è·å–çš„ã€‚



å†çœ‹ä¸€ä¸‹when.tv\_secè·Ÿexec\_timeçš„å«ä¹‰ï¼Œå‰è€…æŒ‡ä»£SQLåœ¨ä¸»åº“ä¸Šçš„SQLæ‰§è¡Œçš„å¼€å§‹æ—¶é—´ï¼Œåè€…æŒ‡ä»£SQLåœ¨ä¸»åº“ä¸Šçš„â€œæ‰§è¡Œæ—¶é•¿â€ï¼Œâ€œæ‰§è¡Œæ—¶é•¿â€åˆè·Ÿâ€œé”é˜»å¡â€ã€â€œä½æ•ˆæ‰§è¡Œè®¡åˆ’â€ã€â€œç¡¬ä»¶èµ„æºä¸è¶³â€ç­‰å› ç´ æ¯æ¯ç›¸å…³ã€‚



å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå‰é¢æåˆ°çš„rli\-\>gaq\-\>head\_queue\(\)\)\-\>tsçš„è®¡ç®—è·Ÿslave\_checkpoint\_periodä»¥åŠ[sql\_delay](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/rpl_slave.cc#L4693)ä¸¤ä¸ªå˜é‡ä¹Ÿæœ‰å…³ç³»ï¼ŒæŒ‰ç…§è¿™ä¸ªæ€è·¯å±‚å±‚è¿­ä»£ä¸‹å»æ‰¾å‡ºæ‰€æœ‰å½±å“seconds\_behind\_masterå€¼çš„å› ç´ ï¼Œè¿™äº›å› ç´ éƒ½æ˜¯æ½œåœ¨çš„ä¸»ä»å»¶è¿Ÿå¼‚å¸¸çš„æ ¹æºï¼Œè¿™æ ·ä¹Ÿè§£å†³äº†å‰é¢è¯´çš„â€œæ— æ³•æšä¸¾æ‰€æœ‰æ ¹å› â€è·Ÿâ€œç¼ºä¹å¯¹æ ¹å› çš„æ·±å±‚æ¬¡ç†è§£â€ä¸¤å¤§é—®é¢˜ã€‚



ä¸ºäº†ä¾¿äºç†è§£ä¸Šè¯‰çš„é€»è¾‘ï¼Œæ”¾å‡ºå…³é”®çš„æºä»£ç ï¼šè·å–last\_master\_timestampå€¼çš„æ¥æºrli\-\>gaq\-\>head\_queue\(\)çš„æˆå‘˜å˜é‡[new\_ts](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/rpl_rli.cc#L347)ã€‚



```
bool mts_checkpoint_routine(Relay_log_info *rli, ulonglong period,
                            bool force, bool need_data_lock)
{
 do
  { 
    cnt= rli->gaq->move_queue_head(&rli->workers);
  } 
 .......................
  ts= rli->gaq->empty()
    ? 0
    : reinterpret_cast<Slave_job_group*>(rli->gaq->head_queue())->ts; //å…¶ä¸­çš„tsæ¥è‡ªä¸‹é¢çš„get_slave_workerå‡½æ•°ï¼›
  rli->reset_notified_checkpoint(cnt, ts, need_data_lock, true);
  //  ç¤¾åŒºç‰ˆæœ¬çš„ä»£ç  rli->reset_notified_checkpoint(cnt, rli->gaq->lwm.ts, need_data_lock);
  /* end-of "Coordinator::"commit_positions" */
 ......................
}
```


è·å–Masterå®ä¾‹ä¸Šæ‰§è¡Œçš„SQLçš„å¼€å§‹è·Ÿæ‰§è¡Œæ—¶é•¿ä¿¡æ¯tv\_secè·Ÿexec\_timeã€‚



```
Slave_worker *Log_event::get_slave_worker(Relay_log_info *rli)
{
if (ends_group() || (!rli->curr_group_seen_begin && (get_type_code() == binary_log::QUERY_EVENT || !rli->curr_group_seen_gtid)))
  {
  ..............
    ptr_group->checkpoint_seqno= rli->checkpoint_seqno;
    ptr_group->ts= common_header->when.tv_sec + (time_t) exec_time; // Seconds_behind_master related
    rli->checkpoint_seqno++;
  }
} 
```


**æ ¹å› å±‚å å›¾**



å¦‚æœè¿›ä¸€æ­¥åˆ†æå†…æ ¸ä»£ç ï¼Œå¯ä»¥å‘ç°å½±å“seconds\_behind\_masterå˜é‡è®¡ç®—çš„å› ç´ è¿˜æœ‰å¾ˆå¤šï¼Œä½†æ˜¯æ‰¾å‡ºè¿™äº›å› ç´ çš„æ€è·¯æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ªæ€è·¯çš„å¥½å¤„æ˜¯ï¼šæ— è®ºä¹‹å‰æœ‰æ²¡æœ‰ç›¸å…³ä¸“å®¶ç»éªŒï¼Œç†è®ºä¸Šè¿™ç§åˆ†ææ–¹å¼éƒ½èƒ½å°½å¯èƒ½åœ°æšä¸¾å‡ºæ‰€æœ‰çš„æ ¹å› ã€‚



é™¤äº†seconds\_behind\_masterï¼Œå…¶ä»–çš„åƒthread\_runningã€Threads\_connectedï¼Œslow\_queriesç­‰æŒ‡æ ‡å¼‚å¸¸çš„åˆ†æä¹Ÿéƒ½å¯ä»¥å¥—ç”¨è¿™ç§æ€è·¯ã€‚ä¸‹é¢ä¸ºæŒ‰ç…§ä¸Šè¿°æ€è·¯æ•´ç†å‡ºæ¥çš„å½±å“seconds\_behind\_masterå€¼çš„éƒ¨åˆ†å› ç´ çš„å±‚æ¬¡ç»“æ„å›¾ï¼š



![](https://p0.meituan.net/travelcube/a91411988d12b209f90dfed6987ccc9e513051.png)



#### 4.1.2 æµç¨‹åˆ†æ


æŠŠå½±å“seconds\_behind\_masterå€¼çš„ç›¸å…³å› ç´ ç¡®è®¤åï¼Œå¯ä»¥ç”»ä¸€ä¸ªæµç¨‹å›¾æŠŠè¿™äº›å› ç´ éƒ½ä½“ç°åœ¨æµç¨‹å›¾ä¸­çš„å…·ä½“ä½ç½®ã€‚è¿™æ ·æ—¢èƒ½æ¯”è¾ƒå½¢è±¡åœ°ç†è§£å½±å“seconds\_behind\_masterçš„å› ç´ åœ¨æ•´ä¸ªä¸»ä»å¤åˆ¶æµç¨‹ä¸­çš„æ‰€å¤„çš„ä½ç½®ï¼Œåˆä¾¿äºå¯¹æ•´ä½“è§„åˆ™è¿›è¡ŒæŸ¥æ¼è¡¥ç¼ºã€‚



ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæ¥è¯´æ˜ä¸€ä¸‹ä¸Šé¢åˆ†æçš„å› ç´ æ˜¯å¦‚ä½•å½±å“seconds\_behind\_masterçš„ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡ŒSQLçš„è¿‡ç¨‹ä¸­å½±å“seconds\_behind\_masterè®¡ç®—çš„ä¸¤ä¸ªå˜é‡thd\-\>start\_timeè·Ÿexec\_timeçš„è®¡ç®—åœ¨masterå®ä¾‹ã€‚å‡è®¾start\_timeçš„å€¼ä¸º2023\-07\-03 00:00:00ï¼ŒSQLæ‰§è¡Œäº†60ç§’ï¼Œæ‰€ä»¥exec\_timeä¸º60ï¼Œ2023\-07\-03 00:01:00ï¼ŒSQLåœ¨ä¸»åº“ä¸Šæ‰§è¡Œå®Œæ¯•ï¼Œåœ¨ä»åº“ä¸Šreplayè¿™ä¸ªSQLï¼Œå¯ä»¥çœ‹åˆ°seconds\_behind\_masterå€¼ä¼šä»0å¼€å§‹å¹¶ä¸”é€æ¸å¢åŠ 60ç§’ï¼Œç„¶åå†è¿”å›0ã€‚



![](https://p1.meituan.net/travelcube/e54c2e0affc14b15872664be42368b3b424554.png)



å…·ä½“åŸå› æ˜¯ï¼šå‡è®¾æˆ‘ä»¬å¿½ç•¥binlogæ—¥å¿—çš„ä¼ è¾“æ—¶é—´ï¼Œé‚£ä¹ˆä»åº“å¼€å§‹æ‰§è¡Œreplayè¿™ä¸ªSQLçš„å¼€å§‹æ—¶é—´ä¹Ÿæ˜¯2023\-07\-03 00:01:00ï¼Œæ‰€ä»¥æ ¹æ®seconds\_behind\_master=\(\(long\)\(time\(0\) \- mi\-\>rli\-\>last\_master\_timestamp\)\- mi\-\>clock\_diff\_with\_masterï¼‰=2023\-07\-03 00:01:00 \- 2023\-07\-03 00:00:00\-60sï¼Œç»“æœå°±æ˜¯0ï¼Œç„¶åSQLçš„æ‰§è¡Œæ—¶é—´æ˜¯60ç§’ï¼Œå¹¶ä¸”\(long\)\(time\(0\)ï¼ˆå½“å‰æ—¶é—´ï¼‰çš„æ—¶é—´ä¸€ç§’ä¸€ç§’çš„åœ¨å¢åŠ ï¼Œæ‰€ä»¥seconds\_behind\_masterå€¼ä¼šä»0å¼€å§‹é€æ¸å¢åŠ è‡³60ç§’ã€‚



å†çœ‹ä¸€ä¸‹å…¶ä»–çš„å› æ•°ï¼Œåè°ƒå™¨ï¼ˆCoordinatorï¼‰ä¼šæŠŠGroupæ”¾å…¥ä¸€ä¸ªå«åšGAP Groupçš„é˜Ÿåˆ—ä¸­ï¼ŒCoordinatorä¼šä»¥slave\_checkpoint\_periodå€¼ä¸ºå‘¨æœŸæ¥æ‰«æGAP Groupä¸­çš„å…ƒç´ å¹¶ä¸”æ›´æ–°rli\-\>gaq\-\>head\_queue\(\)\)\-\>tså€¼ï¼Œæ‰€ä»¥æœslave\_checkpoint\_periodçš„å€¼è¢«è®¾ç½®çš„å¾ˆå¤§ï¼Œé‚£ä¹ˆrli\-\>gaq\-\>head\_queue\(\)\)\-\>tsçš„å€¼å› ä¸ºæ²¡æœ‰åŠæ—¶æ›´æ–°è€Œå˜å¾—æ¯”è¾ƒæ—§ï¼Œä»è€Œå¼•èµ·seconds\_behind\_masterå€¼å˜å¤§ã€‚



å¦å¤–ï¼Œæ¯ä¸ªWorkerè¯»å–è‡ªå·±é˜Ÿåˆ—çš„Groupå…ƒç´ ï¼Œè¿›è¡Œrepalyæ“ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯sql\_delayè¿™ä¸ªå˜é‡ï¼Œå¦‚æœå½“å‰æ—¶é—´è¿˜æ²¡æœ‰è¾¾åˆ°sql\_delayè§„å®šçš„æ—¶é—´ï¼ˆå‡è®¾sql\_delayè¢«è®¾ç½®ä¸º100ç§’ï¼Œé‚£ä¹ˆSQLå¯¹åº”çš„binlogæ—¥å¿—åˆ°è¾¾ä»åº“åéœ€è¦ç­‰å¾…100ç§’å†æ‰§è¡Œï¼‰ï¼Œé‚£ä¹ˆworkerå°±ä¸ä¼šè¿›è¡Œrepalyå·¥ä½œï¼Œè¿™é—´æ¥å¯¼è‡´å½±å“è®¡ç®—seconds\_behind\_masterå˜é‡thd\-\>start\_timeå€¼æ¯”æ­£å¸¸æƒ…å†µä¸‹å°äº†100ç§’ï¼Œæ‰€ä»¥å½“workerè¿›è¡Œreplayçš„æ—¶å€™ï¼Œseconds\_behind\_masterçš„å€¼å°±ä¼šç›¸åº”çš„å¢åŠ 100ç§’ã€‚



#### 4.1.3 äº§å“å±•ç¤º


ä¸‹é¢çš„äº§å“å±•ç¤ºäº†å› ä¸ºæµé‡çªå¢è·ŸMDLé”é€ æˆçš„ä¸»ä»å»¶è¿Ÿçš„è¯Šæ–­åˆ†ææŠ¥å‘Šçš„äº§å“é¡µé¢ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæµé‡çªå¢çš„å…·ä½“SQLä»¥åŠMDLé”çš„æŒæœ‰è€…ï¼Œæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œé™æµæˆ–è€…Killæ‰é˜»å¡è€…SQLã€‚



![](https://p0.meituan.net/travelcube/07bf761351be2d0d98b4ad17f2e5fa2e915057.png)



### 4.2 å¤§äº‹åŠ¡è¯Šæ–­åˆ†æï¼ˆå†…æ ¸åŠŸèƒ½å¢å¼ºï¼‰


å¤§äº‹åŠ¡çš„å­˜åœ¨ï¼Œå¯¹æ•´ä¸ªæ•°æ®åº“ç³»ç»Ÿçš„ç¨³å®šæ€§ä¸æ€»ä½“SQLçš„æ€§èƒ½éƒ½ä¼šäº§ç”Ÿå¾ˆå¤§çš„æŒ‘æˆ˜ï¼Œå¦‚å¤§äº‹åŠ¡é•¿æ—¶é—´æŒæœ‰æŸä¸ªé”ä¼šé€ æˆå¤§é¢ç§¯é˜»å¡ï¼Œæˆ–è€…æ›´æ”¹è¿‡å¤šçš„è¡Œæ•°é€ æˆæ•´ä¸ªå®ä¾‹ç¡¬ä»¶èµ„æºçš„ä¸è¶³ã€‚æˆ‘ä»¬éœ€è¦åŠæ—¶å‘ç°è¿™äº›åœºæ™¯ï¼Œå¹¶ä¸”å°†å…¶ä¿¡æ¯å‘é€ç»™ç”¨æˆ·æ²»ç†ï¼Œä½†åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œå¾€å¾€é¢ä¸´å¦‚ä¸‹çš„ä¸¤å¤§æŒ‘æˆ˜ï¼š



**ç¬¬ä¸€ä¸ªæŒ‘æˆ˜**ï¼šæ— æ³•å¾—åˆ°å¤§äº‹åŠ¡æ‰€åŒ…å«çš„å®Œæ•´çš„SQLåˆ—è¡¨ï¼Œé€ æˆç”¨æˆ·ä¸æ¸…æ¥šå¤§äº‹åŠ¡çš„å…¨è²Œæ˜¯ä»€ä¹ˆï¼Œç”¨æˆ·ä¹Ÿå°±æ— æ³•è¯†åˆ«éœ€è¦ä¼˜åŒ–çš„å¤§äº‹åŠ¡ã€‚



* **è§£å†³æ–¹æ¡ˆ**ï¼šæ¯ä¸ªäº‹åŠ¡æ¥MySQLä¼šåœ¨å†…æ ¸å±‚é¢ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼štrx\_idï¼Œå¦‚æœäº‹åŠ¡åŒ…å«çš„æ¯æ¡SQLï¼Œéƒ½ç»™å…¶é™„åŠ ä¸€ä¸ªäº‹åŠ¡ID trx\_idå­—æ®µï¼Œå¹¶ä¸”æŠŠè¿™äº›SQLè¿åŒtrx\_idä¸€èµ·è¾“å‡ºï¼ˆé€šè¿‡å…¨é‡SQLè¾“å‡ºï¼‰ï¼Œé—®é¢˜å°±å¯ä»¥è§£å†³ï¼›ä¸è¿‡è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæŒ‘æˆ˜ï¼Œè¿™ä¸ªäº‹åŠ¡IDåˆ°åº•æ˜¯ä½•æ—¶äº§ç”Ÿçš„å‘¢ï¼Ÿå¦‚ä½•å¤§å®¶ç†Ÿæ‚‰å†…æ ¸å†…éƒ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå°±ä¼šçŸ¥é“äº‹åŠ¡IDçš„åªæœ‰åœ¨äº‹åŠ¡ä¿®æ”¹æ•°æ®çš„æ—¶å€™æ‰ä¼šé€šè¿‡[trx\_assign\_id\_for\_rw](https://github.com/percona/percona-server/blob/release-5.7.41-44/storage/innobase/trx/trx0trx.cc#L1315)è¿™ä¸ªæ–¹æ³•è¢«è·å–ï¼Œè¿™æ„å‘³ç€å°±ä¸‹é¢è¿™ä¸ªå›¾ä¸Šå±•ç¤ºçš„äº‹åŠ¡è€Œè¨€ï¼Œæ˜¯æ— æ³•è·å–SQL4ä¹‹å‰æ‰§è¡Œçš„è¯»SQLè¯­å¥åˆ—è¡¨ï¼Œæ‰€ä»¥è·å–åˆ°çš„äº‹åŠ¡çš„SQLåˆ—è¡¨è¿˜æ˜¯æ®‹ç¼ºçš„ï¼Œé‚£ä¹ˆå¦‚ä½•è·å–åˆ°å®Œæ•´çš„SQLåˆ—è¡¨å‘¢ï¼Ÿè§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥æŠŠäº‹åŠ¡IDçš„ç”Ÿæˆé€»è¾‘æå‰åˆ°åœ¨äº‹åŠ¡åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ç”Ÿæˆå°±å¯ä»¥äº†ã€‚


**ç¬¬äºŒä¸ªæŒ‘æˆ˜**ï¼šå¤§äº‹åŠ¡çš„è€—æ—¶ç»„æˆä¸æ˜ç¡®ã€‚æ•°æ®åº“è§„å®šæ‰§è¡Œæ—¶é•¿å¤§äºæŸä¸ªé˜€å€¼çš„äº‹åŠ¡è¢«å®šä¹‰ä¸ºå¤§äº‹åŠ¡ï¼Œä½†æ˜¯ä¸æ¸…æ¥šè€—æ—¶åˆ°åº•æ˜¯SQLæœ¬èº«çš„æ‰§è¡Œæ—¶é—´è¿˜æ˜¯SQLæ‰§è¡Œä¹‹å¤–çš„è€—æ—¶ï¼ŒSQLæ‰§è¡Œä¹‹å¤–çš„è€—æ—¶å¯èƒ½æ˜¯åœ¨æ‰§è¡Œä¸Šä¸‹ä¸¤ä¸ªSQLä¹‹é—´ï¼Œä¸šåŠ¡ç«¯åœ¨å¤„ç†ä¸€äº›è·Ÿæ•°æ®åº“æ— å…³çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œå»¶è¿Ÿé€ æˆçš„ã€‚



* **è§£å†³æ–¹æ¡ˆ**ï¼šä¸Šè¿°é—®é¢˜å¯ä»¥é€šè¿‡åœ¨æ•°æ®åº“å†…æ ¸å†…å¯¹SQLæ‰§è¡Œå¼€å§‹æ—¶ã€ç»“æŸæ—¶åˆ†åˆ«åŸ‹ç‚¹æ—¶é—´æˆ³æ¥è§£å†³ï¼Œè¿™æ ·æ•´ä¸ªå¤§äº‹åŠ¡æ‰§è¡Œæ€»æ—¶é—´ä¸­æœ‰å¤šå°‘æ—¶é—´æ˜¯åœ¨æ‰§è¡ŒSQLï¼Œæœ‰å¤šå°‘æ—¶é—´æ˜¯åœ¨Sleepå°±ä¸€ç›®äº†ç„¶ï¼›å½“ç„¶ï¼Œè¿™ä¸€å—è¿˜å¯ä»¥åšçš„æ›´åŠ çš„ç»†è‡´ï¼Œæ¯”å¦‚ä¸¤æ¡SQLä¹‹é—´çš„Sleepæ—¶é—´åˆ°åº•æ˜¯ç½‘ç»œå»¶è¿Ÿè¿˜æ˜¯åº”ç”¨ç¨‹åºç«¯çš„å»¶è¿Ÿç­‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥ç»†åˆ†å¤§äº‹åŠ¡é€ æˆçš„åŸå› åˆ°åº•æ˜¯åœ¨MySQLç«¯ã€ç½‘ç»œç«¯è¿˜æ˜¯ç”¨æˆ·è‡ªå·±çš„åº”ç”¨ç¨‹åºé€ æˆçš„ç­‰å¾…ï¼›å…³äºè®¡ç®—ç½‘ç»œç«¯çš„å»¶è¿Ÿè®¡ç®—ï¼Œå¯ä»¥å‚è€ƒMySQLå†…éƒ¨çš„mysql\_socket\_send\_timeè·Ÿvio\_socket\_io\_wait\_timeè¿™2ä¸ªå…³é”®æŒ‡æ ‡çš„å®ç°æ€è·¯ï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªå¤§äº‹åŠ¡çš„SQLåˆ—è¡¨ä»¥åŠè€—æ—¶ç»„æˆåˆ—è¡¨ã€‚


![](https://p0.meituan.net/travelcube/55798c71f409087877650032b039b695522884.png)



#### 4.2.1 äº§å“å±•ç¤º


å†…æ ¸å›¢é˜Ÿé€šè¿‡å†…æ ¸æ”¹é€ ï¼Œå¯¹äº‹åŠ¡ä¸­æ‰€åŒ…å«çš„SQLéƒ½æä¾›äº†trx\_idåå°±å¯ä»¥æ ¹æ®trx\_idæŠŠæ•´ä¸ªäº‹åŠ¡æ‰€æœ‰çš„SQLä¸²èµ·æ¥ã€‚æ ¹æ®SQLæ‰§è¡Œçš„å¼€å§‹è·Ÿç»“æŸæ—¶é—´ï¼Œæˆ‘ä»¬ä¹Ÿæä¾›äº†æ‰€æœ‰SQLä¹‹é—´çš„Sleepæ—¶é—´ï¼ŒæˆåŠŸè§£å†³äº†ä¸Šé¢çš„ä¸¤ä¸ªæŒ‘æˆ˜ï¼Œäº§å“æ•ˆæœå›¾å¦‚ä¸‹ï¼š



![](https://p0.meituan.net/travelcube/e8b93a38b4eb2efc681fbb18df7880bc373306.png)



### 4.3 MySQL Crashåˆ†æï¼ˆå†…æ ¸Core Dumpåˆ†æï¼‰


MySQLå®ä¾‹çªç„¶Crashäº†æ€ä¹ˆè¿›è¡Œæ ¹å› è¯Šæ–­ï¼Ÿè¿›ç¨‹Crashçš„æ ¹å› åˆ†æï¼Œä¹Ÿæ˜¯æ•°æ®åº“æ•…éšœä¸­æœ€éš¾åˆ†æçš„é—®é¢˜ä¹‹ä¸€ã€‚æœ¬èŠ‚æä¾›ä¸€äº›æ€è·¯å°è¯•å»åˆ†æå„ç§åœºæ™¯ä¸‹çš„MySQL Crashçš„æ ¹å› ã€‚



#### 4.3.1 Crashçš„è§¦å‘æ–¹å¼


åœ¨åˆ†æCrashçš„æ ¹å› ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹MySQLè¿›ç¨‹æ˜¯å¦‚ä½•è¢«Crashçš„æ•´ä¸ªè¿‡ç¨‹ååˆ†æœ‰å¿…è¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§¦å‘Crashçš„åŸå› åˆ†æˆä¸¤ç±»ï¼šâ‘ MySQLè¿›ç¨‹è‡ªå·±è§¦å‘äº†Crashï¼ˆè¿™é‡Œç§°ä¹‹ä¸ºMySQLè‡ªæ€ï¼‰ï¼›â‘¡MySQLè¿›ç¨‹è¢«OSæ€æ­»ã€‚



é’ˆå¯¹å‰è€…ï¼Œæ¯”å¦‚MySQLå‘ç°æŸä¸ªå…³é”®æ•°æ®å‘ç”Ÿäº†Data Corruptionã€ç£ç›˜ç©ºé—´ä¸è¶³ã€ç¡¬ä»¶é”™è¯¯ã€ç­‰å¾…å†…æ ¸é”æ—¶é—´è¿‡é•¿ã€MySQL å†…æ ¸Bugç­‰åœºæ™¯ï¼Œéƒ½å¯èƒ½å¯¼è‡´MySQLè‡ªæ€ã€‚å°¤å…¶æ˜¯æ£€æŸ¥åˆ°MySQLå†…æ ¸é‡Œæœ‰äº›æ•°æ®çš„çŠ¶æ€ä¸ç¬¦åˆé¢„æœŸæ—¶ï¼Œæ˜¯å¿…è¦è¦è®©é‚£ä¸ªå®ä¾‹Crashä¹Ÿä¸èƒ½ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™å¯èƒ½ä¼šäº§ç”Ÿæ›´åŠ ä¸¥é‡çš„æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ï¼›è€Œåè€…ï¼ŒOSå¦‚æœå‘ç°ç³»ç»Ÿå†…å­˜ä¸¥é‡ä¸è¶³æˆ–è€…ç©ºæŒ‡é’ˆå¼•ç”¨ç­‰æƒ…å†µï¼Œå°±ä¼šæŠŠåŒ…æ‹¬MySQLåœ¨å†…ç›¸å…³çš„è¿›ç¨‹æ€æ‰ã€‚



åˆ†æä¸€ä¸‹MySQLè‡ªèº«è§¦å‘Crashè¿™ä¸ªåœºæ™¯ï¼Œåœ¨MySQLå†…éƒ¨æœ‰å¾ˆå¤šåœ°æ–¹é€šè¿‡[ut\_a](https://github.com/percona/percona-server/blob/release-5.7.41-44/storage/innobase/include/ut0dbg.h#L59)ï¼ˆå¦‚æœæ˜¯[ut\_error](https://github.com/percona/percona-server/blob/release-5.7.41-44/storage/innobase/include/ut0dbg.h#L67)çš„è¯ï¼Œåˆ™ç›´æ¥è§¦å‘Crashæ–­è¨€å¯¹ç¨‹åºçš„å†…éƒ¨æ•°æ®çŠ¶æ€è¿›è¡Œå¼‚å¸¸æ£€æŸ¥ï¼Œå¦‚æœå‘ç°æ•°æ®çŠ¶æ€ä¸ç¬¦åˆé¢„æœŸï¼Œé‚£ä¹ˆåŠ¿å¿…å‘ç”Ÿäº†Data Corruptionï¼Œè¿™ä¸ªæ—¶å€™ç¨‹åºä¼šè°ƒç”¨[ut\_dbg\_assertion\_failed](https://github.com/percona/percona-server/blob/release-5.7.41-44/storage/innobase/ut/ut0dbg.cc#L41)åœ¨è¿›ç¨‹Crashä¹‹å‰åšä¸€äº›å…³é”®ä¿¡æ¯ï¼ˆå¦‚thread idã€å‘ç”ŸCrashçš„æ–‡ä»¶åå­—è·Ÿcode lineç­‰ï¼‰çš„è®°å½•åï¼Œä¼šç»§ç»­è°ƒç”¨abort\(\)å‘è¿›ç¨‹å‘é€SIGABRTä¿¡å·é‡è®©è¿›ç¨‹Crashæ‰ã€‚



éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»abort\(\)çš„æºç å¯çŸ¥ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸¤æ¬¡[raise \(SIGABRT\)](https://github.com/bminor/glibc/blob/master/stdlib/abort.c#L79)ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨[raise \(SIGABRT\)](https://github.com/bminor/glibc/blob/master/stdlib/abort.c#L79)è§¦å‘å¤„ç†å‡½æ•°[handle\_fatal\_signal](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/signal_handler.cc#L63)ï¼ˆæ­¤å‡½æ•°åœ¨MySQLå®ä¾‹åˆå§‹åŒ–æ—¶é€šè¿‡[sigactionçš„sa\_handler](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/mysqld.cc#L2259)æ³¨å†Œï¼‰è¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ‰“å°ä¸€äº›é‡è¦çš„è°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºåšCore Dumpåˆ†æï¼›ç¬¬äºŒæ¬¡è°ƒç”¨raise \(SIGABRT\)çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†è®©OSç”ŸæˆCore Dumpæ–‡ä»¶ï¼ˆcore Dumpæ–‡ä»¶éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰€æœ‰å¼•èµ·MySQL Crashçš„ç°åœºä¿¡æ¯éƒ½åŒ…å«åœ¨Core Dumpé‡Œé¢ï¼‰ï¼›å¦‚æœæ˜¯åœ¨MySQLè‡ªæ€çš„æƒ…å†µä¸‹å‘ç”Ÿäº†Crash ï¼Œä¸€èˆ¬ä¼šåœ¨errorlogé‡Œä¼šäº§ç”Ÿå¦‚ä¸‹çš„ä¸€æ®µè·ŸCrashç›¸å…³çš„ç°åœºä¿¡æ¯ï¼Œå…¶ä¸­çš„â€œsignalâ€ã€â€œè§¦å‘Crashçš„çº¿ç¨‹å †æ ˆâ€ã€â€œæ­£åœ¨æ‰§è¡Œçš„SQLâ€ç­‰ä¿¡æ¯éƒ½æ˜¯åˆ†æCrashæ ¹å› çš„å…³é”®ä¿¡æ¯ã€‚



ä¸‹å›¾ä¸ºMySQLé€šè¿‡[ut\_a](https://github.com/percona/percona-server/blob/release-5.7.41-44/storage/innobase/include/ut0dbg.h#L59)æ–­è¨€æ£€æŸ¥å¼‚å¸¸é—®é¢˜åå†åˆ°OSè§¦å‘è¿›ç¨‹Crashçš„æ•´ä½“æµç¨‹å›¾ã€‚æ€»ä½“æ¥è¯´ï¼ŒMySQLé€šè¿‡raiseæ¥å‘é€SIGABRTä¿¡å·åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒOSå†…æ ¸å¤„ç†è¿™ä¸ªé˜Ÿåˆ—çš„ä¿¡å·å¹¶è°ƒç”¨MySQLçš„å¤„ç†ç¨‹åºhandle\_fatal\_signalæ¥ä¿ç•™ä¸€äº›å…³é”®çš„ç°åœºä¿¡æ¯ã€‚è¿™é‡Œéœ€è¦æ³¨æ„åˆ°çš„æ˜¯ï¼ŒOSå†…æ ¸åœ¨\_\_setup\_rt\_frameä¸­æ‰§è¡Œâ€œregs\-\>ip = \(unsigned long\) ka\-\>sa.sa\_handler;â€ï¼Œè¿™ä¸ªæ­¥éª¤æ­£æ˜¯è®©MySQLçš„handle\_fatal\_signalæ–¹æ³•è¢«é¡ºåˆ©çš„è°ƒç”¨çš„åŸå› ã€‚



![](https://p0.meituan.net/travelcube/3584a1519afb1735902986c411e1ea57527752.png)



#### 4.3.2 æ ¹æ®Signalç±»å‹åšæ ¹å› åˆ†æ


åˆ†æCrashæ ¹å› çš„ç¬¬ä¸€æ­¥å°±æ˜¯çœ‹è§¦å‘äº†ä»€ä¹ˆç±»å‹çš„signalï¼Œå¸¸è§ç±»å‹æœ‰â€œsignal 6â€ã€â€œsignal 7â€ã€â€œsignal 11â€å‡ ç§ç±»å‹ï¼Œå½“çŸ¥é“äº†Signalç±»å‹åå°±æœ‰ä¸€ä¸ªæ ¹å› åˆ†æçš„å¤§æ–¹å‘ã€‚æ ¹æ®ç»éªŒï¼Œæˆ‘ä»¬å°†å¸¸è§çš„signalç±»å‹ä»¥åŠå¯èƒ½å¼•èµ·çš„åŸå› å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸‹é¢å¯¹äºå¸¸è§çš„signalç±»å‹ä»¥åŠå¼•èµ·çš„æ ¹å› åšä¸€ä¸ªç®€å•çš„åˆ†æã€‚



![](https://p1.meituan.net/travelcube/30f53e4b51e2ad080e43d2c442aaa396183110.png)



\(1\) å¦‚æœæ˜¯signal 6ï¼Œä¸€èˆ¬æ˜¯å®ä¾‹çš„ç£ç›˜ç©ºé—´ä¸è¶³æˆ–è€…ç£ç›˜åªè¯»ï¼ŒMySQLçš„æ•°æ®å‘ç”Ÿäº†data corruptionï¼Œå†…æ ¸å±‚é¢latché”çš„é•¿æ—¶é—´çš„é”ç­‰å¾…é€ æˆã€‚ä¸è¿‡è¿™é‡Œçš„data corruptionã€é•¿æ—¶é—´çš„é”ç­‰å¾…å¯èƒ½æ˜¯ç¡¬ç›˜æŸåæˆ–è€…MySQLçš„Bugé€ æˆçš„ï¼Œåˆ¤æ–­é€»è¾‘å¦‚ä¸‹ï¼š



1. **ç£ç›˜ç©ºé—´ä¸è¶³æˆ–è€…ç£ç›˜åªè¯»**
    * ç£ç›˜å†™æ•°æ®æ—¶ï¼Œå¦‚æœç£ç›˜æ²¡æœ‰å‰©ä½™ç©ºé—´æˆ–è€…æ•°æ®åº“è¢«è®¾ç½®ä¸ºread onlyå°±ä¼šé€ æˆå®ä¾‹çš„Crashï¼Œæ—¥å¿—ä¸­æœ‰â€œEither disk is full or file system is read only while opening the binlogâ€çš„å­—æ ·ã€‚
2. **data corruption**
    * MySQLåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¦‚æœæ–­è¨€ï¼ˆæ¯”å¦‚è¿™é‡Œ[ut\_a\(table \!= NULL](https://github.com/percona/percona-server/blob/release-5.7.41-44/storage/innobase/api/api0api.cc#L936)\)è¿”å›falseï¼Œå¾ˆå¯èƒ½æ˜¯æ•°æ®å‘ç”Ÿäº†corruptionå¹¶ä¸”MySQLå°±ä¼šè‡ªè¡ŒCrashæ‰ï¼›å‘ç”Ÿdata corruptionæ—¶ä¸€èˆ¬åœ¨MySQLçš„error logä¸­æœ‰â€œDatabase page corruption on disk or a failed file read of tablespaceâ€çš„å­—æ ·ï¼Œæ‰€ä»¥æŸ¥çœ‹æ—¥å¿—æ¥åˆ¤æ–­å¦æœ‰ç¡¬ç›˜æ•…éšœé—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰ç¡¬ä»¶æ•…éšœä¿¡æ¯ï¼Œåˆ™å¯èƒ½æ˜¯MySQL Bugé€ æˆçš„data corruptionï¼Œå…·ä½“åˆ†æçœ‹ä¸‹é¢ â€œMySQL Bugâ€é‚£éƒ¨åˆ†ã€‚
3. **é•¿æ—¶é—´æ— æ³•è·å–Latché”**
    * å¦‚æœMySQLé•¿æ—¶é—´æ²¡æœ‰åŠæ³•è·å–åˆ°Latché”ï¼Œé‚£ä¹ˆMySQLè®¤ä¸ºç³»ç»Ÿå¯èƒ½æ˜¯Hangä½äº†ä¹Ÿä¼šå¼•èµ·å®ä¾‹çš„Crashï¼Œå¹¶ä¸”æ—¥å¿—ä¸­æ‰“å°â€œWe intentionally crash the server because it appears to be hungâ€å­—æ ·ï¼Œä¸€èˆ¬æ˜¯ç¡¬ä»¶æ•…éšœé€ æˆçš„æ€§èƒ½é—®é¢˜æˆ–è€…MySQLè‡ªèº«çš„è®¾è®¡ç¼ºé™·å½¢æˆçš„æ€§èƒ½é—®é¢˜é€ æˆçš„ï¼Œè¿™æ¬¡åœºæ™¯æ ¹å› åˆ†ææ¯”è¾ƒæœ‰æŒ‘æˆ˜ã€‚
4. **MySQL Bug**
    * å¦‚æœä¸å±äºä¸Šé¢ä»»ä½•ä¸€ç§æƒ…å†µï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æ˜¯MySQLè‡ªèº«çš„Bugé€ æˆçš„Crashï¼Œæ¯”å¦‚MySQLå¯¹ä¸€äº›SQLè§£ææˆ–è€…æ‰§è¡Œæ—¶ä¼šå‘ç”ŸCrashï¼›è¿™ç§åœºæ™¯ä¸€èˆ¬å…ˆçœ‹ä¸€ä¸‹Crashå‘ç”Ÿæ—¶æ­£åœ¨æ‰§è¡Œçš„SQLæ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªSQLå¯èƒ½å­˜åœ¨äºCrashæ—¥å¿—ä¸­ï¼ˆè¿™ä¸ª[Crashæ—¥å¿—](https://github.com/shenyufengdb/sql/blob/main/crashlog)ä¸­æœ‰ä¸ªä¾‹å­ï¼‰ï¼Œå¯ä»¥å…ˆæŠŠSQLæå–å‡ºæ¥å†æ¬¡æ‰§è¡ŒæŸ¥çœ‹èƒ½å¦å¤ç°é—®é¢˜ï¼›å¦‚æœåœ¨Crashæ—¥å¿—ä¸­çœ‹ä¸åˆ°SQLè¯­å¥ï¼Œå°±éœ€è¦ä»core dumpæ–‡ä»¶ä¸­æå–SQLäº†ï¼Œæå–æ–¹å¼æ˜¯MySQLæ¯ä¸ªé“¾æ¥å¯¹åº”çš„THDçš„æˆå‘˜å˜é‡[m\_query\_string](https://github.com/percona/percona-server/blob/release-5.7.41-44/sql/sql_class.h#L1728)å°±åŒ…å«äº†SQLæ–‡æœ¬ï¼Œåªéœ€è¦æ‰“å¼€Core Dumpæ–‡ä»¶åˆ‡æ¢åˆ°æŸä¸ªåŒ…å«THDå®ä¾‹çš„æ–¹æ³•å†…ï¼Œé€šè¿‡å‘½ä»¤â€œp this\-\>thd\-\>m\_query\_string.str â€æ¥æ‰“å°ï¼Œè¿™é‡Œæœ‰ä¸ª[ä¾‹å­](https://github.com/shenyufengdb/sql/blob/main/sqltext)ã€‚
    * å†ä¸¾ä¸ªMySQLçš„Bugé€ æˆdata corruptionçš„ä¾‹å­ï¼Œä»[Crashæ—¥å¿—](https://github.com/shenyufengdb/sql/blob/main/crashlog)é‡Œâ€œInnoDB: Assertion failure in thread 139605476095744 in file rem0rec.cc line 578â€çœ‹å‡ºï¼Œä»rec\_get\_offsets\_funcå‡½æ•°ä¸­è§¦å‘[ut\_error](https://github.com/percona/percona-server/blob/Percona-Server-5.7.26-29/storage/innobase/rem/rem0rec.cc#L578)è€Œå¯¼è‡´çš„Crashï¼Œä¹‹æ‰€ä»¥è§¦å‘è¿™ä¸ªCrashæ˜¯å› ä¸ºrec\_get\_offsets\_funcä¸­çš„[rec\_get\_status\(rec\)](https://github.com/percona/percona-server/blob/Percona-Server-5.7.26-29/storage/innobase/rem/rem0rec.cc#L561)è·å–åˆ°çš„MySQLçš„è®°å½•ç±»å‹ä¸ç¬¦åˆé¢„æœŸï¼ˆå› ä¸ºè®°å½•ç±»å‹åªæœ‰å›ºå®šçš„REC\_STATUS\_ORDINARYã€REC\_STATUS\_NODE\_PTRï¼ŒREC\_STATUS\_INFIMUMï¼ŒREC\_STATUS\_SUPREMUMè¿™4ç§ç±»å‹ï¼‰ï¼Œå¦‚æœå†…æ ¸å‘ç°ä¸€ä¸ªè®°å½•ç±»å‹ä¸å±äºè¿™4ç§ç±»å‹çš„ä»»ä½•ä¸€ç§ï¼Œé‚£ä¹ˆå°±æ˜¯å‘ç”Ÿäº†data corruptionï¼Œæ‰€ä»¥å¿…é¡»è¦æŠŠè‡ªå·±Crashæ‰ã€‚ä¸ºäº†éªŒè¯åˆšæ‰çš„ç»“è®ºï¼Œçœ‹ä¸€ä¸‹Crashå‘ç”Ÿæ—¶çš„recçš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œä»æºç å¯çŸ¥recçš„ç±»å‹æ˜¯é€šè¿‡[rec\_get\_status](https://github.com/percona/percona-server/blob/Percona-Server-5.7.26-29/storage/innobase/include/rem0rec.ic#L471)è·å–ï¼Œå¹¶ä¸”å…¶é€šè¿‡è°ƒç”¨çš„[rec\_get\_bit\_field\_1](https://github.com/percona/percona-server/blob/Percona-Server-5.7.26-29/storage/innobase/include/rem0rec.ic#L471)è·Ÿ[mach\_read\_from\_1](https://github.com/percona/percona-server/blob/Percona-Server-5.7.26-29/storage/innobase/include/mach0data.ic#L75)ä¸¤ä¸ªå‡½æ•°å¯ä»¥çŸ¥é“recçš„ç±»å‹å…¶å®å°±æ˜¯recè¿™ä¸ªæŒ‡é’ˆå¾€å‰ä¸‰ä¸ªbyteï¼ˆé€šè¿‡\#define REC\_NEW\_STATUS\_MASK 0x7ULå¯çŸ¥ï¼‰ä»£è¡¨çš„å€¼ã€‚
    * é€šè¿‡gdbåŠ è½½core dumpæ–‡ä»¶åï¼Œåˆ‡æ¢åˆ°æŠ›å‡ºexceptionçš„çº¿ç¨‹ï¼Œå› ä¸ºå¼‚å¸¸æ˜¯åœ¨rec\_get\_offsets\_funcé‡ŒæŠ›å‡ºçš„ï¼Œåˆ‡æ¢åˆ°rec\_get\_offsets\_funcå¯¹åº”çš„frame 7æ¥éªŒè¯recçš„ç±»å‹ï¼Œçœ‹åˆ°recçš„æŒ‡é’ˆåœ°å€ä¸º0x7f14b7f5685dï¼ˆç›¸å…³åˆ†ææ•°æ®å¯ä»¥çœ‹æ­¤[é“¾æ¥](https://github.com/shenyufengdb/sql/blob/main/crashlog#L73)ï¼‰ã€‚å‰é¢è¯´è¿‡ï¼Œrecçš„ç±»å‹å€¼åœ¨recæŒ‡é’ˆå¾€å‰ä¸‰ä¸ªbyteé‡Œï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆ0x7f14b7f5685aï¼ˆ0x7f14b7f5685d\-3ï¼‰é‚£ä¸ªä½ç½®çš„å€¼ï¼Œå‘ç°æ˜¯0x1fï¼Œæ‰§è¡Œä¸è®¡ç®—ï¼ˆ11111\(1f\)&00111\(0x7UL\)=00111=7 ï¼‰å¾—åˆ°çš„ç±»å‹æ˜¯7ï¼Œè€Œè®°å½•ç±»å‹çš„èŒƒå›´æ˜¯ï¼ˆ0ï½3ï¼‰ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„è®°å½•ç±»å‹å€¼ä¿¡æ¯å‘ç”Ÿäº†data corruptionï¼ˆåˆ†æè¿‡ç¨‹æŸ¥çœ‹æ­¤[é“¾æ¥](https://github.com/shenyufengdb/sql/blob/main/crashlog#L91)ï¼‰ï¼Œè¿™é‡Œåšäº†ä¸€ä¸ªrecçš„ç±»å‹åœ¨æ­£å¸¸æƒ…å†µä¸‹è·Ÿæœ¬ä¾‹å¼‚å¸¸æƒ…å†µä¸‹çš„ç±»å‹å€¼è®¡ç®—çš„å¯¹æ¯”è¡¨ï¼Œå‘ç°æ­£å¸¸æƒ…å†µä¸‹ï¼Œrecçš„ç±»å‹å€¼å°±åº”è¯¥æ˜¯3ã€‚


![](https://p0.meituan.net/travelcube/a44621f7f6308a814fdfdf062ca74a58244702.png)



* è¿™é‡Œæœ‰ä¸ªé‡è¦é—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆrecçš„ç±»å‹æ˜¯æ— æ•ˆçš„å‘¢ï¼Ÿå¾ˆå¯èƒ½æ˜¯MySQLæœç´¢æ»¡è¶³æ¡ä»¶çš„è®°å½•çš„æ—¶å€™ï¼ŒrecæŒ‡å‘çš„è®°å½•å¾ˆå¯èƒ½è¢«page\_cleaneråœ¨åå°è¢«æ¸…ç†æ‰äº†ï¼Œæ‰€ä»¥recæŒ‡é’ˆæŒ‡å‘çš„è®°å½•å°±æ˜¯æ— æ•ˆäº†ã€‚å®˜æ–¹æœ‰ä¸ªbugfixï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯æŠŠprev\_recè®¾ç½®ä¸ºNULLï¼ˆè¿™é‡Œçš„prev\_recæ˜¯persistent cursoræŒ‡å‘çš„è®°å½•ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹persistent cursorï¼Œå®ƒæ˜¯MySQLä»InnoDB å±‚è·å¾—è®°å½•åè¿›å…¥SQLå±‚å‰åœ¨B\-treeä¸Šçš„cursorä¼šè¢«æš‚æ—¶å­˜å‚¨åˆ°row\_prebuilt\_t::pcurä¸­ï¼Œå½“å†æ¬¡ä»InnoDBå±‚æ‹¿æ•°æ®æ—¶ï¼Œå¦‚æœå¯¹åº”çš„buf\_block\_tæ²¡æœ‰å‘ç”Ÿä¿®æ”¹ï¼Œåˆ™å¯ä»¥ç»§ç»­æ²¿ç”¨ä¹‹å‰å­˜å‚¨çš„cursorï¼Œå¦åˆ™éœ€è¦é‡æ–°å®šä½ï¼Œå¦‚æœæ²¡æœ‰persistent cursoråˆ™æ¯æ¬¡éƒ½éœ€è¦é‡æ–°å®šä½åˆ™å¯¹æ€§èƒ½æœ‰å½±å“ï¼‰ï¼Œè¿™æ ·[prev\_rec \!= NULL](https://github.com/percona/percona-server/blob/Percona-Server-5.7.26-29/storage/innobase/row/row0sel.cc#L5370)è¿™ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œä¹Ÿå°±æ²¡æœ‰æœºä¼šè¿›å…¥rec\_get\_offsets\_g\_funcé‡Œå»æ£€æŸ¥recçš„ç±»å‹å€¼è€Œå¼•å‘Crashäº†ã€‚


ï¼ˆ2\) å¦‚æœä¸ºsignal 7ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯å†…å­˜ç¡¬ä»¶é”™è¯¯ï¼Œå¹¶ä¸”æ—¥å¿—é‡Œä¸€èˆ¬æœ‰â€œmce: \[Hardware Error\]: Machine check events logged ï¼Œ mce: Uncorrected hardware memory error in user\-access at xxx MCE xxx: Killing mysqld:xxx due to hardware memory corruptionâ€ç­‰å­—æ ·ã€‚



ï¼ˆ3\) å¦‚æœä¸ºsignal 9ï¼Œè¡¨ç¤ºè¿™ä¸ªè¿›ç¨‹è¢«Killå‘½ä»¤æ€æ‰äº†ã€‚



ï¼ˆ4\) å¦‚æœä¸ºsignal 11ï¼Œè¡¨ç¤ºæ˜¯ç”±MySQLçš„Bugé€ æˆçš„ï¼Œè¿™ç±»é—®é¢˜è¾ƒéš¾åˆ†æç‰¹åˆ«æ˜¯MySQL Crashç°åœºï¼ˆé€šè¿‡core dumpæ‰“å°å‡ºæ¥çš„å †æ ˆä¿¡æ¯ï¼‰å¾€å¾€è¿˜ä¸æ˜¯ç¬¬ä¸€ç°åœºï¼Œç”±äºç¯‡å¹…å…³ç³»å…·ä½“çš„ä¾‹å­åˆ†æä¸åœ¨æœ¬æ–‡ä¸­ç»™å‡ºï¼Œä½†æ˜¯åˆ†æçš„æ€è·¯è·Ÿä¸Šé¢çš„â€œMySQL Bugâ€æ˜¯ç±»ä¼¼çš„ã€‚



## 5 æœ¬æ–‡ä½œè€…


è£•é”‹ï¼Œæ¥è‡ªç¾å›¢åŸºç¡€ç ”å‘å¹³å°\-åŸºç¡€æŠ€æœ¯éƒ¨ï¼Œè´Ÿè´£ç¾å›¢æ•°æ®åº“è‡ªæ²»å¹³å°çš„ç›¸å…³å·¥ä½œã€‚



## 6 å‚è€ƒ


* [https://github.com/shenyufengdb/sql](https://github.com/shenyufengdb/sql)
* [https://github.com/percona/percona\-server/blob/release\-5.7.41\-44](https://github.com/percona/percona-server/tree/release-5.7.41-44)
* [An Efficient, Cost\-Driven Index Selection Tool for Microsoft SQL Server](https://www.microsoft.com/en-us/research/publication/an-efficient-cost-driven-index-selection-tool-for-microsoft-sql-server/)
* [plan\-stitch\-harnessing\-the\-best\-of\-many\-plans\-2](https://www.microsoft.com/en-us/research/publication/plan-stitch-harnessing-the-best-of-many-plans-2/)
* [Random Sampling for Histogram Construction: How Much is Enough?](https://www.microsoft.com/en-us/research/publication/random-sampling-for-histogram-construction-how-much-is-enough/)
* [AutoAdmin â€œwhat\-ifâ€ index analysis utility](https://dl.acm.org/doi/10.1145/276304.276337)
* [What is a Self\-Driving Database Management System?](https://www.cs.cmu.edu/~pavlo/blog/2018/04/what-is-a-self-driving-database-management-system.html)
* [https://www.microsoft.com/en\-us/research/publication/self\-tuning\-database\-systems\-a\-decade\-of\-progress/](https://www.microsoft.com/en-us/research/publication/self-tuning-database-systems-a-decade-of-progress/)
* [Automatic Database Management System Tuning Through Large\-scale Machine Learning](https://www.cs.cmu.edu/~pavlo/papers/p1009-van-aken.pdf)
* [Query\-based Workload Forecasting for Self\-Driving Database Management Systems](https://db.cs.cmu.edu/papers/2018/forecasting-sigmod2018.pdf)
* [The TSA Method](https://www.brendangregg.com/tsamethod.html)
* [https://blog.langchain.dev/langchain\-chat/](https://blog.langchain.dev/langchain-chat/)
* [https://github.com/hwchase17/langchain](https://github.com/hwchase17/langchain)
* [REAC T: SYNERGIZING REASONING AND ACTING IN LANGUAGE MODELS](https://arxiv.org/pdf/2210.03629.pdf)
* [Evaluating the Text\-to\-SQL Capabilities of Large Language Models](https://arxiv.org/abs/2204.00498)
* [SQL\-PALM: IMPROVED LARGE LANGUAGE MODEL ADAPTATION FOR TEXT\-TO\-SQL](https://arxiv.org/pdf/2306.00739.pdf)




